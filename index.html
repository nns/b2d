<!doctype html>
<html>
   <head>
      <title>Demo</title>
	   <script src="/socket.io/socket.io.js"></script>
	   <script type="text/javascript">
	   function init(){
	   	var canvas = document.getElementById('canvas');
  		var ctx = canvas.getContext('2d');
  		ctx.strokeStyle = '#eee';
	   	var socket = io.connect();
	   	
	   	var array = [];
	   	socket.on('action',function(data){
	   		array.push(data);
	   	});
	   	setInterval(update,1000/60);
	   	
	   	function update(){	
	   		var tmp = array.slice(0);
	   		if(tmp.length == 0) return;
		   	tmp.forEach(function(v,i){
		   		ctx.save();
		   		ctx.clearRect.call(ctx,0,0,600,400);
		   		v.forEach(function(vv,ii){
			   		var data = vv.args;
			   		switch(vv.process){
			   			case 'beginPath':
			   				ctx.beginPath();
			   				break;
			   			case 'moveTo':
			   				ctx.moveTo.apply(ctx,data);
			   				break;
			   			case 'lineTo':
			   				ctx.lineTo.apply(ctx,data);
			   				break;
			   			case 'closePath':
			   				ctx.closePath();
			   				break;
			   			case 'stroke':
			   				ctx.stroke();
			   				break;
			   			case 'fill':
			   				ctx.fill();
			   				break;
			   			case 'arc':
			   				ctx.arc.apply(ctx,data);
			   				break;
			   			case 'clearRect':
			   				ctx.clearRect.apply(ctx,data);
			   				break;
			   			case 'strokeStyle':
			   				ctx.strokeStyle = data;
			   				break;
						case 'fillStyle':
			   				ctx.fillStyle = data;
			   				break;
			   		}
		   		});
		   		ctx.restore();
		   		array.shift();
		   	});
	   	}
			function mv(e){
				console.log('mousemove:%s:%s',e.clientX/30,e.clientY/30);
				socket.emit('mouse move',{x:e.clientX, y:e.clientY});
			}
			document.onmousedown = function(){
				console.log('mousedown');
				document.onmousemove = mv;
			};
			document.onmouseup = function(){
				console.log('mouseup');
				socket.emit('mouse up');
				document.onmousemove = function(){};
			};
	   }
	   </script>
   </head>
   <body onload="init();">
  	<canvas id='canvas' width='600' height='400' style='background-color:#eee;'></canvas>
   </body>
</html>
